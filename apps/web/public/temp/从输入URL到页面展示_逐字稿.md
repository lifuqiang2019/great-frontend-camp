# 面试模拟：从输入 URL 到页面展示

**面试官**：这是一个非常经典的问题，请详细描述一下从我们在浏览器地址栏输入 URL 到最终页面展示出来的全过程。希望你能尽可能全面地覆盖到网络、渲染以及可能涉及的高级特性。

---

**候选人**：

好的，这是一个非常宏大且细节丰富的话题。为了条理清晰，我通常将这个过程分为五个主要阶段来阐述：**浏览器预处理**、**网络通信**、**页面渲染**，以及针对特定场景的 **WebGL 渲染** 和 **WebRTC 通信**。

### 第一阶段：浏览器预处理

当我们还在地址栏输入的时候，浏览器其实就已经开始工作了。

首先是**输入解析与合法性检查**。浏览器会实时判断我输入的到底是 URL 还是搜索关键词。
*   如果我输的是不带协议头的关键词，比如 "javascript"，浏览器会把它组装成默认搜索引擎的 URL。
*   如果我输的是符合规则的 URL，比如 "google.com"，浏览器会做一些自动补全，比如加上 `http://` 协议头。

这里有一个很重要的安全机制叫 **HSTS**。浏览器会检查这个域名是否在 HSTS 的预加载列表中。如果在，浏览器会强制把请求升级为 `https://`，这样从第一次请求开始就是加密的，能有效防止降级攻击。此外，浏览器还会查一下本地的“安全浏览列表”，看看是不是钓鱼网站。

当 URL 确定后，**浏览器主进程**会通过 IPC 进程间通信，把这个请求任务交给**网络进程**，这就进入了第二阶段。

### 第二阶段：网络通信

网络进程接管后，数据就开始在网络上传输了。

1.  **DNS 解析**：首先要把域名变成 IP。浏览器会按顺序查找缓存：浏览器缓存 -> 系统 hosts -> 路由器缓存 -> ISP DNS。如果都没命中，就会发起递归查询，直到找到目标 IP。
2.  **建立连接**：拿到 IP 后，如果是 HTTP 协议，就是经典的 **TCP 三次握手**（SYN, SYN-ACK, ACK）。如果是 HTTPS，在 TCP 握手之后，还需要进行 **TLS 四次握手**来交换密钥，建立加密通道。
3.  **发送请求与接收响应**：连接建立好后，浏览器发送 HTTP 请求报文。服务器处理完后，返回响应报文。如果状态码是 200，且 Content-Type 是 `text/html`，网络进程就会通知渲染进程准备开始干活了。

### 第三阶段：页面渲染（核心）

这是前端最关注的部分。渲染引擎拿到 HTML 数据后，会通过一条流水线来处理：

1.  **解析**：解析 HTML 构建 **DOM 树**，解析 CSS 构建 **CSSOM 树**。
2.  **构建渲染树 (Render Tree)**：把 DOM 和 CSSOM 结合起来。这里要注意，像 `display: none` 的节点会被剔除，因为它们不需要显示，但 `visibility: hidden` 的节点会保留。
3.  **布局 (Layout)**：也就是常说的 Reflow。计算出每个节点在屏幕上的确切坐标和大小。
4.  **绘制 (Paint)**：把这些节点转换成像素，填充颜色、边框、阴影等。
5.  **合成 (Composite)**：现在的浏览器都是分层渲染的。这一步是将不同的图层（Layer）在 GPU 中进行合成，最终显示在屏幕上。

### 第四阶段：进阶场景 —— WebGL

如果页面里有 `<canvas>` 并且使用了 3D 上下文（比如 Three.js），渲染流程会切到 **WebGL 管线**。这就不是简单的画像素了，而是涉及 CPU 到 GPU 的数据传输。
主要流程包括：**顶点着色器**处理坐标，**图元装配**组装三角形，**光栅化**把几何图形变成像素，**片元着色器**上色，最后进行**深度测试**和**混合**，输出到帧缓冲区。

### 第五阶段：进阶场景 —— WebRTC

如果这个页面是一个视频会议页面，还会触发 **WebRTC** 流程。
这时候浏览器需要建立 **P2P 连接**。它会通过信令服务器交换 SDP 信息，利用 STUN/TURN 服务器进行 ICE 穿透（也就是打洞，获取公网 IP），然后进行 DTLS 握手建立加密通道，最后通过 SRTP 协议传输实时的音视频流。

### 总结

所以，从输入 URL 到看到页面，其实是一场涉及 **进程协作（IPC）**、**网络协议栈（DNS/TCP/TLS）**、**渲染引擎流水线** 以及 **GPU 加速** 的复杂接力赛。作为前端工程师，理解这个链路能帮我们更好地做性能优化，比如 DNS 预解析、减少重排重绘、利用合成层加速等等。
