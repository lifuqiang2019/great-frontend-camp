# 如果你的网站加载时间过长，你会如何诊断并解决此问题?

## 简短回答

遇到页面加载慢，千万不要瞎猜。首先要像医生看病一样，用工具 (**Lighthouse / Chrome DevTools**) **确诊**瓶颈在哪里——是网络请求慢 (TTFB)、资源体积大 (Content Download)、还是 JS 执行卡 (Script Evaluation)？确诊后才能对症下药，常见的药方包括：CDN 加速、代码分割、Gzip/Brotli 压缩、以及优化关键渲染路径。

---

## 1. 科学诊断 (Metrics first)

不要凭感觉说“慢”，要用数据说话。我们可以使用 **PerformanceObserver** 在生产环境监听核心指标 (Web Vitals)。

```javascript
// 监听 LCP (最大内容绘制)：衡量页面主要内容多久能被用户看到
new PerformanceObserver((entryList) => {
  for (const entry of entryList.getEntries()) {
    console.log('LCP candidate:', entry.startTime, entry);
  }
}).observe({type: 'largest-contentful-paint', buffered: true});

// 监听 Long Task (长任务)：衡量页面是否卡顿
new PerformanceObserver((entryList) => {
  for (const entry of entryList.getEntries()) {
    // 超过 50ms 的任务都被视为长任务，会阻塞主线程
    console.log('Long Task:', entry.duration);
  }
}).observe({type: 'longtask', buffered: true});
```

## 2. 解决方案：分层治理

诊断出问题后，我们可以从以下几个层面入手：

*   **网络层**：
    *   升级 HTTP/2 (多路复用)。
    *   利用 CDN 边缘节点缓存。
    *   开启 Brotli 压缩 (比 Gzip 强 20%)。
*   **资源层**：
    *   图片转 WebP (体积减小 30%)。
    *   路由懒加载 (Code Splitting)，不加载当前页面不需要的 JS。
*   **渲染层**：
    *   优化关键渲染路径，告诉浏览器哪些资源是急需的。

## 3. 预加载策略 (Resource Hints)

通过 HTML 标签告诉浏览器提前干活：

```html
<!-- 高优先级加载关键资源 (如字体、首屏 JS) -->
<link rel="preload" href="main.js" as="script">
<link rel="preload" href="font.woff2" as="font" crossorigin>

<!-- 空闲时加载下一页可能用到的资源 (预测加载) -->
<link rel="prefetch" href="next-page.js">
```
