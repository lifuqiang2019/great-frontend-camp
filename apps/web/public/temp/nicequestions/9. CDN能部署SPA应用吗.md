# CDN能部署SPA应用吗?

## 简短回答

SPA (单页应用) 部署到 CDN 最头疼的问题就是**刷新报 404**。这是因为 CDN/服务器上只有一个真实的 `index.html`，它不知道 `/user/profile` 这种前端路由。解决办法是配置服务器 (Nginx) 做 **Rewrite**，凡是找不到的文件都返回 `index.html`。另外，配合合理的**缓存策略**（HTML 不缓存，JS/CSS 强缓存），可以实现秒开且无缝升级。

---

## 1. History 路由的 404 问题

当用户直接访问 `https://site.com/user/profile` 时：
1.  浏览器向服务器请求 `/user/profile`。
2.  服务器找了一圈，发现没有这个目录或文件。
3.  服务器返回 404 Not Found。

**解决方案：Nginx Rewrite (Try Files)**
告诉 Nginx：先找文件，找不到就当成是 SPA 的入口，返回 index.html，剩下的交给前端路由处理。

```nginx
location / {
  root   /usr/share/nginx/html;
  index  index.html index.htm;
  # 核心配置：尝试查找文件($uri)，找不到则回退到 /index.html
  try_files $uri $uri/ /index.html;
}
```

## 2. 极致缓存策略 (Cache-Control)

为了让网站加载更快，我们要充分利用浏览器缓存，但要避免“发布了新版用户还在看旧版”的问题。

*   **index.html (入口文件)**：**协商缓存** 或 **不缓存**。
    *   因为它里面引用了 JS/CSS 的路径，它必须是最新的。
    ```http
    Cache-Control: no-cache
    ```

*   **JS/CSS/图片 (静态资源)**：**强缓存 (永不过期)**。
    *   前提是文件名必须带 Hash (如 `app.a1b2c.js`)。只要内容变了，Hash 就变了，文件名也就变了，视为新资源。
    ```http
    Cache-Control: max-age=31536000, immutable
    ```

## 3. 发布流程 (非覆盖式)

标准的 SPA 发布流程应该是：
1.  **构建**：生成带 Hash 的静态资源。
2.  **上传**：将 JS/CSS 上传到 CDN (可以与旧版本共存)。
3.  **部署**：最后更新 `index.html` (覆盖旧的)，指向新的 JS 路径。
