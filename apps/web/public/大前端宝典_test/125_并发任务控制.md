# 并发任务控制

```javascript
async function timeout(time) {  
return new Promise(resolve => {  
setTimeout(() => {  
resolve();  
}, time);  
})  
}  
  
class SuperTask {  
// 代码实现  
}  
  
const superTask = new SuperTask({ poolSize: 2 });  
function addTask(time, name) {  
const label = \`任务${name}，完成\`;  
console.time(label);  
superTask.add(() => timeout(time)).then(() => {  
console.timeEnd(label);  
})  
}  
  
addTask(10000, 1); // 10s 后输出：任务1完成  
addTask(5000, 2); // 5s 后输出：任务2完成  
addTask(3000, 3); // 8s 后输出：任务3完成  
addTask(4000, 4); // 11s 后输出：任务4完成  
addTask(5000, 5); // 12s 后输出：任务5完成  
setTimeout(() => { superTask.setPoolSize(5); }, 7000);

答案：

```

```javascript
async function timeout(time) {  
return new Promise(resolve => {  
setTimeout(() => {  
resolve();  
}, time);  
})  
}  
class SuperTask {  
constructor({ poolSize }) {  
this.waiting = \[\];  
this.poolSize = poolSize || 2;  
this.runningTaskCount = 0;  
}  
setPoolSize(size) {  
this.poolSize = size;  
this.runTask();  
}  
add(fn) {  
return new Promise(resolve => {  
this.waiting.push({ fn, resolve });  
this.runTask();  
});  
}  
runTask() {  
while (this.runningTaskCount < this.poolSize && this.waiting.length > 0) {  
const { fn, resolve } = this.waiting.shift();  
this.runningTaskCount++;  
fn().then(() => {  
resolve();  
this.runningTaskCount--;  
this.runTask();  
})  
}  
}  
}  
const superTask = new SuperTask({ poolSize: 2 });  
function addTask(time, name) {  
const label = \`任务${name}，完成\`;  
console.time(label);  
superTask.add(() => timeout(time)).then(() => {  
console.timeEnd(label);  
})  
}  
  
addTask(10000, 1); // 10s 后输出：任务1完成  
addTask(5000, 2); // 5s 后输出：任务2完成  
addTask(3000, 3); // 8s 后输出：任务3完成  
addTask(4000, 4); // 11s 后输出：任务4完成  
addTask(5000, 5); // 12s 后输出：任务5完成  
setTimeout(() => { superTask.setPoolSize(5); }, 7000);

```
