# 浏览器缓存（强缓存 / 协商缓存）

若缓存生效，强缓存返回200，协商缓存返回 304 状态码。

**强缓存：**

- Cache-Control : max-age=3600 （单位秒）

```javascript
// 服务器  
async cacheControlTest(ctx) {  
// 模拟3秒请求数据  
await new Promise(resolve => {  
setTimeout(() => {  
resolve();  
}, 3000);  
});  
ctx.set(  
'Cache-Control',  
'public, max-age=10'  
);  
this.success(ctx);  
}

```
- Expires : new Date(Date.now() + 10 \* 1000).toUTCString()

```javascript
// 服务器  
async expiresTest(ctx) {  
// 模拟3秒请求数据  
await new Promise(resolve => {  
setTimeout(() => {  
resolve();  
}, 3000);  
});  
ctx.set(  
'Expires',  
new Date(Date.now() + 10 \* 1000).toUTCString()  
);  
this.success(ctx);  
}

```
**协商缓存：**

- ETag / If-None-Match

```javascript
// 服务器  
async etagTest(ctx) {  
// 模拟资源数据  
const resource = { id: 1, name: 'Example\_Resource' };  
  
// 生成 ETag  
const resourceETag = md5(\`${resource.id}-${resource.name}\`);  
  
// 检查客户端发送的 If-None-Match 头  
const requestETag = ctx.get('If-None-Match');  
if (requestETag === resourceETag) {  
// 如果请求的 ETag 与资源的 ETag 匹配，则返回 304 Not Modified  
ctx.status = 304;  
return;  
}  
  
// 模拟3秒请求数据  
await new Promise(resolve => {  
setTimeout(() => {  
resolve();  
}, 3000);  
});  
  
// 设置响应头中的 ETag  
ctx.set('ETag', resourceETag);  
  
this.success(ctx, resource);  
}

```
- Last-Modified / If-Modified-Since

```javascript
// 服务器  
async lastModifiedTest(ctx) {  
// 模拟资源数据  
const resource = { id: 1, name: 'Example\_Resource' };  
  
// 模拟最后修改时间  
const lastModifiedTime = 1689253117727;  
  
// 检查客户端发送的 if-modified-since 头  
const ifModifiedSince = ctx.get('If-Modified-Since');  
if (ifModifiedSince && new Date(ifModifiedSince).getTime() > lastModifiedTime) {  
// 如果请求的 If-Modified-Since 大于最后修改时间，直接返回缓存状态码  
ctx.status = 304;  
return;  
}  
  
// 模拟3秒请求  
await new Promise(resolve => {  
setTimeout(() => {  
resolve();  
}, 3000);  
});  
  
// 设置响应头中的 ETag  
ctx.set('Last-Modified', new Date(lastModifiedTime).toUTCString());  
  
this.success(ctx, resource);  
}

**相关文章（万字长文）：** https://www.zhihu.com/question/318091919/answer/2376806633?utm\_id=0

```
